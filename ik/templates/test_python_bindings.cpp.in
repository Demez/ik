#include "gmock/gmock.h"
#include "Python.h"
#include "ik/ik.h"

#define NAME python_bindings

PyMODINIT_FUNC PyInit_ik(void);

using namespace ::testing;

void init_python(void)
{
    PyImport_AppendInittab("ik", PyInit_ik);
    Py_Initialize();
    // "module 'sys' has no attribute 'argv'"
    PyRun_SimpleString("import sys\nsys.argv = ['']");
    // sys.exit() would cause the program to exit. Raise an exception instead so PyRun_SimpleString() returns non-zero if exit was called
    PyRun_SimpleString(
        "import sys\n"
        "def stub(x):\n"
        "    if x:\n"
        "        raise RuntimeError(\"sys.exit({})\".format(x))\n"
        "sys.exit = stub");
}

int deinit_python()
{
    return Py_FinalizeEx();
}

class PythonEnvironment : public testing::Environment
{
public:
    virtual void SetUp() override
    {
        init_python();
    }

    virtual void TearDown() override
    {
        EXPECT_THAT(deinit_python(), Eq(0));
    }
};

const testing::Environment* const pythonEnvironment =
        testing::AddGlobalTestEnvironment(new PythonEnvironment);

TEST(NAME, module_import_many_times)
{
    for (int i = 0; i != 20; ++i)
    {
        PyRun_SimpleString("import ik");
        deinit_python();
        init_python();
    }
}
